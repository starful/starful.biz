import pandas as pd
import os
import google.generativeai as genai
import time
import logging
import json
import re
from dotenv import load_dotenv
from google.generativeai.types import BlockedPromptException

# --- .env íŒŒì¼ ë¡œë“œ ---
load_dotenv()

# --- ì„¤ì • ---
API_KEY = os.getenv("GEMINI_API_KEY")
if not API_KEY:
    raise ValueError("GEMINI_API_KEYê°€ .env íŒŒì¼ì— ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

genai.configure(api_key=API_KEY)
MODEL_NAME = "gemini-flash-latest"
OUTPUT_DIR = "../app/contents/"
CSV_FILE = "data/positions.csv"
LOG_FILE = "log/generation_log.txt"

# --- ìƒì„±í•  íŒŒì¼ì˜ ìµœëŒ€ ê°œìˆ˜ (10ê±´ìœ¼ë¡œ ë³€ê²½) ---
num_to_generate = 30

# ë””ë ‰í† ë¦¬ ìƒì„±
os.makedirs(os.path.dirname(LOG_FILE), exist_ok=True)
os.makedirs(OUTPUT_DIR, exist_ok=True)

# --- ë¡œê¹… ì„¤ì • (ì„±ê³µ ë¡œê·¸ë§Œ íŒŒì¼ì— ê¸°ë¡) ---
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - CREATED: %(message)s',
    handlers=[
        logging.FileHandler(LOG_FILE, mode='a', encoding='utf-8')
    ]
)

# Gemini ëª¨ë¸ ì´ˆê¸°í™”
model = genai.GenerativeModel(MODEL_NAME)

# --- Frontmatter ìƒì„±ìš© í”„ë¡¬í”„íŠ¸ ---
FRONTMATTER_PROMPT = """
ã‚ãªãŸã¯ã€ITãŠã‚ˆã³æŠ€è¡“è·å‹™ã«é–¢ã™ã‚‹ãƒ–ãƒ­ã‚°è¨˜äº‹ã®**Markdown Frontmatter (JSONå½¢å¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿)**ã‚’ç”Ÿæˆã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚
ä»¥ä¸‹ã®ã€Œ{position_name}ã€ã«é–¢ã™ã‚‹Frontmatterã‚’ã€ä»¥ä¸‹ã®æ§‹é€ ã‚’å³å®ˆã—ã€**å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«é©åˆ‡ãªå†…å®¹ã‚’å®Œç’§ã«åŸ‹ã‚ã¦**æ—¥æœ¬èªã§ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
**çµ¶å¯¾ã«ã€ã„ã‹ãªã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ç©ºã«ã—ãŸã‚Šã€çœç•¥ã—ãŸã‚Šã€é€”ä¸­ã§ç”Ÿæˆã‚’ä¸­æ–­ã—ãŸã‚Šã—ãªã„ã§ãã ã•ã„ã€‚**
ä½™è¨ˆãªèª¬æ˜ã‚„ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚

---json
{{
  "category": "{{é©åˆ‡ãªã‚«ãƒ†ã‚´ãƒªåï¼ˆä¾‹: engineering, ai-data, design, marketing, cloud-infra, product-management, cyber-security, sales-bizdev, customer-success, content-strategyã®ä¸­ã‹ã‚‰æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã‚’å¿…ãš1ã¤é¸æŠã™ã‚‹ã“ã¨ï¼‰}}",
  "keywords": [{{è·å‹™ã«é–¢é€£ã™ã‚‹ä¸»è¦ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’5ã€œ10å€‹ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§æ–‡å­—åˆ—ã¨ã—ã¦å…·ä½“çš„ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚ä¾‹: "AI", "æ©Ÿæ¢°å­¦ç¿’", "ãƒ‡ãƒ¼ã‚¿åˆ†æ", "Python"}}],
  "meta_description": "{{è·å‹™ã®å®šç¾©ã€ä¸»ãªæ¥­å‹™ã€å¿…è¦ãªã‚¹ã‚­ãƒ«ã€ã‚­ãƒ£ãƒªã‚¢ãƒ‘ã‚¹ã‚’ç¶²ç¾…ã™ã‚‹ç°¡æ½”ãªèª¬æ˜ï¼ˆæ—¥æœ¬èªã§80ã€œ120å­—ç¨‹åº¦ã§å…·ä½“çš„ã«è¨˜è¿°ã™ã‚‹ã“ã¨ï¼‰}}",
  "related_jobs": [{{é–¢é€£æ€§ã®é«˜ã„è·å‹™ã®slugã‚’2ã€œ3å€‹ã€æ–‡å­—åˆ—ã¨ã—ã¦è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚æ—¢å­˜ã®ITè·å‹™åã‹ã‚‰æƒ³åƒã—ã¦ç”Ÿæˆã™ã‚‹ã“ã¨ã€‚é–¢é€£è·å‹™ãŒãªã„å ´åˆã¯**å¿…ãš**ã€Œ[]ã€ã¨è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚ä¾‹: ["backend_developer", "security_engineer"]}}],
  "slug": "{{è·å‹™åã‚’ã‚±ãƒãƒ–ã‚±ãƒ¼ã‚¹ã«å¤‰æ›ã—ãŸãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDï¼ˆä¾‹: webmaster, application_security_engineerï¼‰ã€‚å°æ–‡å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã‚’ä½¿ç”¨ã—ã€æ—¥æœ¬èªåã‹ã‚‰æ­£ç¢ºã«ç”Ÿæˆã™ã‚‹ã“ã¨}}",
  "tags": [{{è·å‹™ã«é–¢é€£ã™ã‚‹æŠ€è¡“ã€ãƒ„ãƒ¼ãƒ«ã€æ¦‚å¿µã‚¿ã‚°ã‚’5ã€œ10å€‹ã€æ–‡å­—åˆ—ã¨ã—ã¦è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚æ—¥æœ¬èªã§å…·ä½“çš„ã«è¨˜è¿°ã™ã‚‹ã“ã¨ã€‚ä¾‹: "Python", "SQL", "AWS", "ãƒ‡ãƒ¼ã‚¿å¯è¦–åŒ–"}}],
  "thumbnail": "/static/img/{{slug}}.png",
  "hero_image": "/static/img/{{slug}}_hero.png",
  "title": "{{è·å‹™ã®æ ¸å¿ƒçš„ãªå½¹å‰²ã‚’ç¤ºã™é­…åŠ›çš„ãªã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ—¥æœ¬èªã§30å­—ä»¥å†…ï¼‰}}"
}}
---

**é‡è¦:** å‡ºåŠ›ã¯**ä¸Šè¨˜ã®`---json`ã§å§‹ã¾ã‚Š`---`ã§çµ‚ã‚ã‚‹JSONãƒ–ãƒ­ãƒƒã‚¯ã®ã¿**ã¨ã—ã€ä½™è¨ˆãªèª¬æ˜ã‚„ãƒ†ã‚­ã‚¹ãƒˆã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚`{{...}}`ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯å…¨ã¦ã€é©åˆ‡ãªå†…å®¹ã§ç½®ãæ›ãˆã€**JSONã®æ§‹é€ ã‚’å®Œç’§ã«éµå®ˆ**ã—ã¦ãã ã•ã„ã€‚
"""

# --- ë³¸ë¬¸ ì½˜í…ì¸  ìƒì„±ìš© í”„ë¡¬í”„íŠ¸ ---
BODY_PROMPT = """
# ğŸ¯ ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

ã‚ãªãŸã¯**ITãŠã‚ˆã³æŠ€è¡“è·å‹™ã«é–¢ã™ã‚‹è©³ç´°ãªåˆ†æã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’åˆ¶ä½œã™ã‚‹å°‚é–€ãƒ–ãƒ­ã‚¬ãƒ¼**ã§ã™ã€‚
ç›®æ¨™ã¯ã€èª­è€…ãŒç‰¹å®šã®è·å‹™ã‚’å®Œç’§ã«ç†è§£ã§ãã‚‹ã‚ˆã†ã€**ä½“ç³»çš„ã§è¦–è¦šçš„ã«é­…åŠ›çš„ãªãƒ–ãƒ­ã‚°è¨˜äº‹**ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã™ã€‚

ä»¥ä¸‹ã®**ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ§‹é€ **ã¨**ãƒ–ãƒ­ã‚°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¬ã‚¤ãƒ‰**ã‚’å¿…ãšéµå®ˆã—ã€
è¦æ±‚ã•ã‚ŒãŸã€Œ{position_name}ã€ã«é–¢ã™ã‚‹å°‚é–€çš„ãªãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’**æ—¥æœ¬èªã§**ä½œæˆã—ã¦ãã ã•ã„ã€‚

---

## ğŸ§© ä½œæˆæ¡ä»¶
- **åˆ†é‡**: **æ—¥æœ¬èªã§9,000å­—ã€œ10,000å­—ç¨‹åº¦**ã€‚å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§è©³ç´°ãªæƒ…å ±ã‚’å«ã‚ã¤ã¤ã€å†—é•·ãªè¡¨ç¾ã‚’é¿ã‘ã¦ãã ã•ã„ã€‚
- **å‡ºåŠ›è¨€èª**: **æ—¥æœ¬èª**
- **ãƒˆãƒ¼ãƒ³**: å°‚é–€çš„ã§ã‚ã‚ŠãªãŒã‚‰è¦ªåˆ‡ã§ç†è§£ã—ã‚„ã™ã„å£èª¿
- **ã‚¹ã‚¿ã‚¤ãƒ«**: æ´»æ°—ãŒã‚ã‚Šã€è¦–è¦šçš„è¦ç´ ï¼ˆçµµæ–‡å­—ã€å¼·èª¿ã€å¼•ç”¨ï¼‰ã‚’ç©æ¥µçš„ã«æ´»ç”¨
- **å½¢å¼**: ã¯ã¦ãªãƒ–ãƒ­ã‚°ã«æœ€é©åŒ–ã•ã‚ŒãŸ**Markdown**å½¢å¼

# ã€æœ€é‡è¦æŒ‡ç¤ºã€‘
- **å‰ç½®ãã‚„æŒ¨æ‹¶ã€ã€Œæ‰¿çŸ¥ã„ãŸã—ã¾ã—ãŸã€ã®ã‚ˆã†ãªå¿œç­”ã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚å¿…ãšä»¥ä¸‹ã®ã€Œãƒ–ãƒ­ã‚°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¬ã‚¤ãƒ‰ã€ã§æŒ‡å®šã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«å½¢å¼ã‹ã‚‰å‡ºåŠ›ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚**
- **ã€è¿½åŠ æŒ‡ç¤ºã€‘æ–‡å­—æ•°ã¨å†…å®¹ã®ãƒãƒ©ãƒ³ã‚¹**: æŒ‡å®šã•ã‚ŒãŸæ–‡å­—æ•°ï¼ˆ9,000ã€œ10,000å­—ï¼‰ã®ç¯„å›²å†…ã§ã€å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’æ·±ãæ˜ã‚Šä¸‹ã’ã¦ãã ã•ã„ã€‚æ–‡å­—æ•°ã‚’æº€ãŸã™ãŸã‚ã ã‘ã®ä¸­èº«ã®ãªã„æ–‡ç« ã¯é¿ã‘ã€è³ªã®é«˜ã„æƒ…å ±ã‚’å‡ç¸®ã—ã¦åŸ·ç­†ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚**ç‰¹ã«ã€å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ååˆ†ãªè©³ç´°ã¨ä¾‹ã‚’å«ã‚ã€æŒ‡å®šæ–‡å­—æ•°ã«åˆ°é”ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚**
- **ã€è¿½åŠ æŒ‡ç¤ºã€‘å‡ºåŠ›ã®å®Œå…¨æ€§**: ãƒ¬ãƒãƒ¼ãƒˆã¯çµ¶å¯¾ã«é€”ä¸­ã§ä¸­æ–­ã›ãšã€å¿…ãšæœ«å°¾ã®ã€Œ#æ¨å¥¨ã‚¿ã‚°ã€ã¾ã§ã€å…¨ã¦ã®ç« ã‚’å®Œå…¨ãªå½¢ã§å‡ºåŠ›ã€‘ã—ã¦ãã ã•ã„ã€‚**é€”ä¸­ã§ç”ŸæˆãŒæ­¢ã¾ã‚‹ã“ã¨ã¯è¨±å®¹ã•ã‚Œã¾ã›ã‚“ã€‚**

---

## ğŸ§± ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ§‹é€ ï¼ˆæ˜ç¢ºåŒ–ã•ã‚ŒãŸ10å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

**ã€æ§‹é€ ã®éµå®ˆã‚’å¾¹åº•ã€‘ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç•ªå·ã¨ã‚¿ã‚¤ãƒˆãƒ«ã€å†…å®¹ã®æŒ‡ç¤ºã‚’å³å®ˆã—ã¦ãã ã•ã„ã€‚**

1ï¸âƒ£ **{position_name}ã¨ã¯ï¼Ÿ**
- ãƒã‚¸ã‚·ãƒ§ãƒ³ã®é‡è¦æ€§ã‚’**æ¯”å–©**ã‚’ç”¨ã„ã¦èª¬æ˜ã—ã€è¨˜äº‹å…¨ä½“ã®æ–¹å‘æ€§ã‚’ç´¹ä»‹ã™ã‚‹ã€‚**ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€è·å‹™ã®èƒŒæ™¯ã€ç¾ä»£ç¤¾ä¼šã«ãŠã‘ã‚‹æ„ç¾©ã€ãã—ã¦èª­è€…ã®èˆˆå‘³ã‚’å¼·ãå¼•ãã¤ã‘ã‚‹ã‚ˆã†ãªå°å…¥ã‚’ã€å…·ä½“çš„ãªä¾‹ã‚’è±Šå¯Œã«äº¤ãˆãªãŒã‚‰ã€æœ€ä½ã§ã‚‚400å­—ä»¥ä¸Šã§è©³ç´°ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚**

***

2ï¸âƒ£ **ä¸»ãªæ¥­å‹™**
- `{position_name}`ãŒæ‹…ã†**æ ¸å¿ƒçš„ãªç›®æ¨™ã¨ä¸»è¦ãªè²¬ä»»ï¼ˆæ¥­å‹™ï¼‰**ã‚’5ã€œ7ã¤ã®å…·ä½“çš„ãªãƒã‚¤ãƒ³ãƒˆã«ã¾ã¨ã‚ã¦ã€åˆ†ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¦ãã ã•ã„ã€‚å„ãƒã‚¤ãƒ³ãƒˆã«ã¯è©³ç´°ãªèª¬æ˜ã‚’å«ã‚ã¦ãã ã•ã„ã€‚

***

3ï¸âƒ£ **å¿…è¦ãªã‚¹ã‚­ãƒ«ã¨ãƒ„ãƒ¼ãƒ«**
- **ã€æœ€é‡è¦æŒ‡ç¤ºã€‘ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€ä»¥ä¸‹ã®æ§‹æˆã®ã€Markdownã®è¡¨å½¢å¼ã€‘ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚**
- **ã€å³å®ˆã€‘è¡¨ã®å„ã‚»ãƒ«å†…ã§çµ¶å¯¾ã«æ”¹è¡Œï¼ˆ\\nï¼‰ã‚’å…¥ã‚Œãªã„ã§ãã ã•ã„ã€‚å„è¡Œã¯å¿…ãšä¸€è¡Œã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚**
- **å„ã‚«ãƒ†ã‚´ãƒªã«ã¤ã„ã¦ã€æœ€ä½ã§ã‚‚3ã€œ5ã¤ã®å…·ä½“çš„ãªé …ç›®ã‚’å«ã‚ã¦ãã ã•ã„ã€‚**

**### ğŸš€ æŠ€è¡“ã‚¹ã‚­ãƒ«ï¼ˆãƒãƒ¼ãƒ‰ã‚¹ã‚­ãƒ«ï¼‰**
```markdown
| ã‚¹ã‚­ãƒ« | è©³ç´°ãªèª¬æ˜ï¼ˆå…·ä½“çš„ãªæŠ€è¡“åã‚„æ¦‚å¿µã‚’å«ã‚€ï¼‰ |
| :--- | :--- |
| ã‚¯ãƒ©ã‚¦ãƒ‰ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° | AWS, Azure, GCPãªã©ã®ä¸»è¦ã‚µãƒ¼ãƒ“ã‚¹ã®çŸ¥è­˜ã¨è¨­è¨ˆçµŒé¨“ã€‚ |
| ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èª | Python, Java, Goãªã©ã®è¨€èªç‰¹æ€§ã®ç†è§£ã¨é¸å®šèƒ½åŠ›ã€‚ |
... (5ã€œ7è¡Œç¨‹åº¦)

### ğŸ¤ çµ„ç¹”ãƒ»ç®¡ç†ã‚¹ã‚­ãƒ«ï¼ˆã‚½ãƒ•ãƒˆã‚¹ã‚­ãƒ«ï¼‰
| ã‚¹ã‚­ãƒ« | è©³ç´°ãªèª¬æ˜ |
| :--- | :--- |
| æˆ¦ç•¥çš„æ€è€ƒ | ãƒ“ã‚¸ãƒã‚¹ç›®æ¨™ã¨æŠ€è¡“æˆ¦ç•¥ã‚’ãƒªãƒ³ã‚¯ã•ã›ã‚‹èƒ½åŠ›ã€‚ |
| ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ | éæŠ€è¡“è€…ã¸ã®èª¬æ˜èƒ½åŠ›ã¨äº¤æ¸‰åŠ›ã€‚ |
... (3ã€œ5è¡Œç¨‹åº¦)

### ğŸ’» ãƒ„ãƒ¼ãƒ«ãƒ»ã‚µãƒ¼ãƒ“ã‚¹
| ãƒ„ãƒ¼ãƒ«ã‚«ãƒ†ã‚´ãƒª | å…·ä½“çš„ãªãƒ„ãƒ¼ãƒ«åã¨ç”¨é€” |
| :--- | :--- |
| CI/CDãƒ„ãƒ¼ãƒ« | Jenkins, GitHub Actionsãªã©ã‚’ç”¨ã„ãŸè‡ªå‹•åŒ–ã€‚ |
| ç›£è¦–ãƒ„ãƒ¼ãƒ« | Datadog, Prometheusãªã©ã«ã‚ˆã‚‹ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ã€‚ |
... (5ã€œ7è¡Œç¨‹åº¦)```

***

4ï¸âƒ£ **{position_name}ã®å”æ¥­ã‚¹ã‚¿ã‚¤ãƒ«**
- `{position_name}`ãŒé€£æºã™ã‚‹**ä¸»è¦ãªéƒ¨é–€ã‚„å½¹å‰²**ã‚’3ã€œ5ã¤æŒ™ã’ã€ãã‚Œãã‚Œã¨ã®**å…·ä½“çš„ãªé€£æºå†…å®¹ã¨ç›®çš„**ã‚’è©³ã—ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚
- **ã€æœ€é‡è¦æŒ‡ç¤ºã€‘å„éƒ¨é–€ã®èª¬æ˜ã¯ã€å¿…ãšä»¥ä¸‹ã®Markdownæ§‹é€ ã‚’å³å®ˆã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã¨ç®‡æ¡æ›¸ããƒªã‚¹ãƒˆã®é–“ã«ã¯å¿…ãšã€ç©ºè¡Œã‚’1è¡Œã€‘æŒ¿å…¥ã—ã¦ãã ã•ã„ã€‚**
    ```markdown
    ### [é€£æºã™ã‚‹éƒ¨é–€å]
    **é€£æºå†…å®¹ã¨ç›®çš„:**
    [ã“ã“ã«éƒ¨é–€ã¨ã®é€£æºå†…å®¹ã«é–¢ã™ã‚‹è©³ç´°ãªèª¬æ˜æ–‡ã‚’è¨˜è¿°ã—ã¾ã™ã€‚]

    *   **å…·ä½“çš„ãªé€£æº:** [å…·ä½“çš„ãªé€£æºå†…å®¹ã‚’è¨˜è¿°]
    *   **ç›®çš„:** [é€£æºã®ç›®çš„ã‚’è¨˜è¿°]
    ```

***

5ï¸âƒ£ **ã‚­ãƒ£ãƒªã‚¢ãƒ‘ã‚¹ã¨æˆé•·ã®æ–¹å‘æ€§**
- **ã€æœ€é‡è¦æŒ‡ç¤ºã€‘ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€æ–‡ç« ã§ã®èª¬æ˜ã§ã¯ãªãã€ä»¥ä¸‹ã®æ§‹æˆã®ã€Markdownã®è¡¨å½¢å¼ã€‘ã§ã‚­ãƒ£ãƒªã‚¢ãƒ‘ã‚¹ã®è¦ç‚¹ã‚’ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚**
- **ã€å³å®ˆã€‘è¡¨ã®å„ã‚»ãƒ«å†…ã§çµ¶å¯¾ã«æ”¹è¡Œï¼ˆ\\nï¼‰ã‚’å…¥ã‚Œãªã„ã§ãã ã•ã„ã€‚å„è¡Œã¯å¿…ãšä¸€è¡Œã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚**
    ```markdown
    | ã‚­ãƒ£ãƒªã‚¢æ®µéš | ä¸»ãªå½¹å‰²ã¨è²¬ä»» | ä»Šå¾Œã®å±•æœ› |
    | :--- | :--- | :--- |
    | ã‚¸ãƒ¥ãƒ‹ã‚¢é–‹ç™ºè€… | ç‰¹å®šã®æ©Ÿèƒ½ã®å®Ÿè£…ã€ã‚³ãƒ¼ãƒ‰å“è³ªç¶­æŒ | å°‚é–€æ€§æ·±åŒ–ã€ã‚·ã‚¹ãƒ†ãƒ ç†è§£ |
    | ã‚·ãƒ‹ã‚¢é–‹ç™ºè€… | æŠ€è¡“çš„æ„æ€æ±ºå®šã€ãƒ¡ãƒ³ãƒãƒ¼æŒ‡å° | éæ©Ÿèƒ½è¦ä»¶è¨­è¨ˆã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆå€™è£œ |
    ```
- **è¡Œæ•°ã¯æœ€ä½5è¡Œã€å„åˆ—ã®å†…å®¹ã¯å…·ä½“çš„ãªä¾‹ã‚’å«ã¿ã€ç°¡æ½”ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚**

***

6ï¸âƒ£ **{position_name}ã®å°†æ¥å±•æœ›ã¨é‡è¦æ€§ã®é«˜ã¾ã‚Š**
- ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–ã‚„æŠ€è¡“ã®é€²åŒ–ã«ä¼´ã„ã€ã“ã®è·å‹™ãŒå°†æ¥çš„ã«ã©ã®ã‚ˆã†ã«å¤‰åŒ–ã—ã€ãã®é‡è¦æ€§ãŒãªãœé«˜ã¾ã‚‹ã®ã‹ã‚’5ã€œ7ã¤ã®ãƒã‚¤ãƒ³ãƒˆã«åˆ†ã‘ã¦è©³ç´°ã«è§£èª¬ã—ã¦ãã ã•ã„ã€‚å…·ä½“çš„ãªãƒˆãƒ¬ãƒ³ãƒ‰ã‚„æŠ€è¡“é©æ–°ã«è§¦ã‚Œã¦ãã ã•ã„ã€‚

***

7ï¸âƒ£ **{position_name}ã«ãªã‚‹ãŸã‚ã®å­¦ç¿’æ–¹æ³•**
- `{position_name}`ã«ãªã‚‹ãŸã‚ã«å¿…è¦ãªã‚¹ã‚­ãƒ«ã‚’ç¿’å¾—ã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªå­¦ç¿’æ–¹æ³•ã‚„ãƒªã‚½ãƒ¼ã‚¹ã‚’5ã€œ7ã¤ã®æ®µéšã¾ãŸã¯ãƒ†ãƒ¼ãƒã«åˆ†ã‘ã¦è©³ã—ãèª¬æ˜ã—ã¦ãã ã•ã„ã€‚
- **ã€æœ€é‡è¦æŒ‡ç¤ºã€‘å„å­¦ç¿’ã‚¹ãƒ†ãƒƒãƒ—ã¯ã€å¿…ãšä»¥ä¸‹ã®Markdownæ§‹é€ ã‚’å³å®ˆã—ã¦ãã ã•ã„ã€‚è¦‹å‡ºã—(###)ã¨ãƒªã‚¹ãƒˆ(*)ã®é–“ã«ã¯ç©ºè¡Œã‚’1è¡Œå…¥ã‚Œã€ç›®çš„ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯åŒã˜éšå±¤ã®ãƒªã‚¹ãƒˆã«ã—ã¦ãã ã•ã„ã€‚**
    ```markdown
    ### X. [XXXXXXXX]

    *   **ç›®çš„:** [XXXXXXX]
    *   **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
        *   **æ›¸ç±:** [æ¨è–¦æ›¸ç±ã¨ãã®ç†ç”±ã‚’è¨˜è¿°ã—ã¾ã™ã€‚]
        *   **ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ã‚¹:** [æ¨è–¦ã‚³ãƒ¼ã‚¹ã‚„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¨˜è¿°ã—ã¾ã™ã€‚]
    ```

***

8ï¸âƒ£ **æ—¥æœ¬ã§ã®å°±è·å¯èƒ½ãªä¼æ¥­**
- `{position_name}`ãŒæ´»èºã§ãã‚‹**æ—¥æœ¬ã®ä¼æ¥­ã‚„æ¥­ç•Œ**ã‚’3ã€œ5ã¤å…·ä½“çš„ã«æŒ™ã’ã€ãã‚Œãã‚Œã®ä¼æ¥­ã‚¿ã‚¤ãƒ—ãŒã“ã®è·å‹™ã‚’ã©ã®ã‚ˆã†ã«æ´»ç”¨ã—ã¦ã„ã‚‹ã‹ã‚’ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

***

9ï¸âƒ£ **é¢æ¥ã§ã‚ˆãã‚ã‚‹è³ªå•ã¨ãã®å¯¾ç­–**
- **ã€æŒ‡ç¤ºã€‘** å®Ÿéš›ã®é¢æ¥ã§å‡ºé¡Œã•ã‚Œãã†ãª**ã€æŠ€è¡“è³ªå•ã€‘**ã®ä»£è¡¨çš„ãªä¾‹ã‚’**10ã€œ15å€‹**ã€ç®‡æ¡æ›¸ãã§æç¤ºã—ã¦ãã ã•ã„ã€‚**è¡Œå‹•ã«é–¢ã™ã‚‹è³ªå•ã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚**
- **ã€æŒ‡ç¤ºã€‘å„è³ªå•ã«ã¯ã€å›ç­”ã®ãƒã‚¤ãƒ³ãƒˆã‚‚ç°¡æ½”ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚**

***

ğŸ”Ÿ **ã¾ã¨ã‚**
- è¨˜äº‹ã®æ ¸å¿ƒã‚’è¦ç´„ã—ã€è·å‹™ã®**ä¾¡å€¤ã¨é­…åŠ›**ã‚’å¼·èª¿ã—ã¦ç· ã‚ããã‚Šã¾ã™ã€‚èª­è€…ãŒè¡Œå‹•ã‚’èµ·ã“ã™ãã£ã‹ã‘ã¨ãªã‚‹ã‚ˆã†ãªåŠ›å¼·ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ç· ã‚ã¦ãã ã•ã„ã€‚

---

## ğŸª„ ãƒ–ãƒ­ã‚°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¬ã‚¤ãƒ‰ï¼ˆMarkdownå½¢å¼ã‚’éµå®ˆï¼‰

- **è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«**:
`# [å®Œå…¨ã‚¬ã‚¤ãƒ‰] {position_name}: {title_from_frontmatter}` # Frontmatterã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸtitleã‚’ä½¿ç”¨

---

## ğŸ·ï¸ #æ¨å¥¨ã‚¿ã‚°
ã“ã®æŠ•ç¨¿ã«é©ã—ãŸæ¤œç´¢ç”¨ã®ã‚¿ã‚°ã‚’5ã¤ææ¡ˆã—ã¦ãã ã•ã„ã€‚
ä¾‹: `#ARé–‹ç™º #VRæŠ€è¡“ #XRã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ #ãƒ¡ã‚¿ãƒãƒ¼ã‚¹ #æŠ€è¡“è·å‹™åˆ†æ`

---

## ğŸŒ å‡ºåŠ›è¨€èª
**æ—¥æœ¬èª**
"""

def generate_frontmatter(position_name):
    """Frontmatterë¥¼ ìƒì„±í•˜ê³  íŒŒì‹±í•©ë‹ˆë‹¤. ì‹¤íŒ¨ ì‹œ Noneì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
    full_prompt = FRONTMATTER_PROMPT.format(position_name=position_name)
    try:
        response = model.generate_content(
            full_prompt,
            generation_config=genai.types.GenerationConfig(
                temperature=0.2
            )
        )
        generated_text = response.text
        json_match = re.search(r'(\{.*\})', generated_text, re.DOTALL)
        if not json_match:
            return None
        
        parsed_json = json.loads(json_match.group(0).strip())
        
        required_fields = ["category", "slug", "title"]
        if any(field not in parsed_json for field in required_fields):
            return None

        return parsed_json
    except Exception:
        return None

def generate_body(position_name, frontmatter_data):
    """ë³¸ë¬¸ ì½˜í…ì¸ ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì‹¤íŒ¨ ì‹œ Noneì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
    title = frontmatter_data.get('title', "è©³ç´°ã‚¬ã‚¤ãƒ‰")
    full_prompt = BODY_PROMPT.format(position_name=position_name, title_from_frontmatter=title)
    try:
        response = model.generate_content(
            full_prompt,
            generation_config=genai.types.GenerationConfig(
                temperature=0.3
            )
        )
        return response.text
    except Exception:
        return None

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    try:
        df = pd.read_csv(CSV_FILE)
    except FileNotFoundError:
        print(f"ã‚¨ãƒ©ãƒ¼: CSVãƒ•ã‚¡ã‚¤ãƒ« '{CSV_FILE}' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        return

    positions = df['position_name'].tolist()
    
    positions_to_generate = []
    for pos in positions:
        slug = pos.replace('/', '_').replace(' ', '_').replace('(', '').replace(')', '').replace(',', '').replace('"', '').lower()
        filepath = os.path.join(OUTPUT_DIR, f"{slug}.md")
        if not os.path.exists(filepath):
            positions_to_generate.append(pos)
    
    if not positions_to_generate:
        print("æ–°ã—ã„ã‚¬ã‚¤ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚")
        return

    actual_files_to_generate = min(num_to_generate, len(positions_to_generate))
    generated_count = 0

    print(f"ã‚¬ã‚¤ãƒ‰ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™ã€‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: {actual_files_to_generate}ä»¶")

    for position in positions_to_generate:
        if generated_count >= num_to_generate:
            break

        progress_prefix = f"[{generated_count + 1}/{actual_files_to_generate}]"
        print(f"{progress_prefix} {position} ã‚’å‡¦ç†ä¸­...", end="", flush=True)

        # 1. Frontmatter ìƒì„±
        frontmatter = generate_frontmatter(position)
        if not frontmatter:
            print(" å¤±æ•— (Frontmatterç”Ÿæˆã‚¨ãƒ©ãƒ¼)")
            time.sleep(15)
            continue
        
        slug = frontmatter.get('slug', position.lower().replace(' ', '_'))
        output_filepath = os.path.join(OUTPUT_DIR, f"{slug}.md")

        # 2. ë³¸ë¬¸ ìƒì„±
        body = generate_body(position, frontmatter)
        if not body:
            print(" å¤±æ•— (æœ¬æ–‡ç”Ÿæˆã‚¨ãƒ©ãƒ¼)")
            time.sleep(15)
            continue

        # 3. íŒŒì¼ ì €ì¥
        frontmatter_str = f"---json\n{json.dumps(frontmatter, ensure_ascii=False, indent=2)}\n---\n"
        final_content = frontmatter_str + body

        try:
            with open(output_filepath, 'w', encoding='utf-8') as f:
                f.write(final_content)
            
            print(" å®Œäº†")
            logging.info(output_filepath) # ì„±ê³µ ë¡œê·¸ ê¸°ë¡
            generated_count += 1
        except IOError as e:
            print(f" å¤±æ•— (ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e})")

        time.sleep(15) # API ì†ë„ ì œí•œ ë°©ì§€

    print(f"\nç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ãŒå®Œäº†ã—ã¾ã—ãŸã€‚{generated_count}ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚")
    print(f"è©³ç´°ã¯ '{LOG_FILE}' ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")

if __name__ == "__main__":
    main()