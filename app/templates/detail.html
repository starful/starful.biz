{% extends "base.html" %}

{% block head %}
<title>{{ item.title }} | Starful</title>
<meta name="description" content="{{ item.meta_description }}">
<!-- detail.html의 block head에 추가 -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "{{ item.title }}",
  "description": "{{ item.meta_description }}",
  "author": {
    "@type": "Organization",
    "name": "Starful"
  },
  "image": "{{ item.thumbnail }}",
  "publisher": {
    "@type": "Organization",
    "name": "Starful",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starful.biz/static/img/logo.png"
    }
  }
}
</script>
<style>
    /* --- 기초 레이아웃 & 짤림 방지 --- */
    :root {
        --article-width: 780px; /* PC 가독성 황금 너비 */
    }

    body {
        background-color: #ffffff;
        margin: 0; padding: 0;
        overflow-x: hidden; /* 가로 스크롤 원천 차단 */
    }

    /* --- [Header] 타이포그래피 --- */
    .detail-header {
        max-width: var(--article-width);
        margin: 0 auto;
        padding: 80px 24px 40px;
        box-sizing: border-box;
    }
    .detail-header .breadcrumb {
        color: var(--accent);
        font-weight: 800;
        font-size: 0.9rem;
        display: block;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .detail-header h1 {
        font-size: clamp(2rem, 7vw, 3.2rem);
        font-weight: 800;
        line-height: 1.25;
        margin: 0;
        color: #1d1d1f;
        word-break: break-all; /* 일본어/한국어 짤림 방지 */
        overflow-wrap: break-word;
    }
    .detail-header .lead-text {
        color: #666;
        font-size: 1.25rem;
        line-height: 1.6;
        margin-top: 25px;
        font-weight: 400;
    }

    /* --- [Content Body] 가독성 시스템 --- */
    .detail-body {
        max-width: var(--article-width);
        margin: 0 auto;
        padding: 0 24px 100px;
        box-sizing: border-box;
        font-size: 1.18rem;
        line-height: 2.1; /* 장문을 위한 넉넉한 행간 */
        color: #2c2c2e;
        word-wrap: break-word;
        word-break: break-all;
    }

    /* 제목 스타일 */
    .detail-body h2 {
        font-size: 2.1rem;
        font-weight: 800;
        margin: 90px 0 35px;
        padding-bottom: 15px;
        border-bottom: 4px solid #f2f2f2;
        position: relative;
        letter-spacing: -0.04em;
    }
    .detail-body h2::after {
        content: ''; position: absolute; bottom: -4px; left: 0;
        width: 100px; height: 4px; background: var(--accent);
    }
    .detail-body h3 { font-size: 1.6rem; font-weight: 700; margin: 50px 0 24px; }
    .detail-body p { margin-bottom: 35px; }

    /* --- [Summary Card] 요약 박스 --- */
    .summary-card {
        background: #f9f9fb;
        border-radius: 24px;
        padding: 40px;
        margin: 40px 0 60px;
        border: 1px solid #efeff4;
        border-left: 8px solid var(--accent);
        box-sizing: border-box;
    }
    .summary-card h3 { margin: 0 0 20px 0 !important; font-size: 1.3rem; }
    .summary-card ul { list-style: none !important; padding: 0 !important; margin: 0 !important; }
    .summary-card li { margin-bottom: 12px; display: flex; gap: 12px; font-size: 1.05rem; align-items: flex-start; }
    .summary-card li i { color: var(--accent); margin-top: 6px; flex-shrink: 0; }

    /* --- [TOC] 자동 목차 --- */
    .toc-container {
        background: #fff;
        border: 1px solid #e5e5e7;
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 60px;
    }
    .toc-title { font-weight: 800; margin-bottom: 15px; font-size: 1rem; }
    #toc-list { list-style: none; padding: 0; margin: 0; }
    #toc-list li { margin-bottom: 8px; }
    #toc-list a { color: #666; text-decoration: none; font-size: 0.95rem; }
    .toc-h3 { padding-left: 20px; font-size: 0.9rem !important; }

    /* --- [Table] 모바일 대응 표 디자인 --- */
    .table-wrapper {
        width: 100%;
        overflow-x: auto;
        margin: 40px 0;
        border-radius: 16px;
        border: 1px solid #e5e5e7;
        box-shadow: 0 10px 40px rgba(0,0,0,0.03);
    }
    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
    }
    th, td { padding: 20px; text-align: left; border-bottom: 1px solid #efeff4; }
    th { background: #f9f9fb; font-weight: 700; color: #1d1d1f; }

    /* --- [Ad Slot] availableWidth=0 에러 방지용 컨테이너 --- */
    .ad-slot-detail {
        width: 100% !important;
        max-width: 100%;
        margin: 40px 0;
        min-height: 280px; /* 자리 미리 확보 */
        text-align: center;
        background: #fafafa;
        display: block;
        overflow: hidden;
    }

    /* --- 모바일 대응 --- */
    @media (max-width: 768px) {
        .detail-header { padding: 60px 20px 30px; }
        .detail-body { padding: 0 20px 80px; font-size: 1.1rem; line-height: 1.85; }
        .detail-body h2 { font-size: 1.7rem; }
        .summary-card { padding: 25px; border-radius: 16px; }
    }
</style>
{% endblock %}

{% block content %}
<main style="width: 100%; overflow-x: hidden;">
    <!-- Header -->
    <header class="detail-header">
        <span class="breadcrumb">{{ category_title }} GUIDE</span>
        <h1>{{ item.title }}</h1>
        <p class="lead-text">{{ item.meta_description }}</p>
    </header>

    <div class="detail-body">
        
        <!-- 퀵 사마리 박스 -->
        <div class="summary-card">
            <h3 style="margin-top:0;"><i class="fa-solid fa-bolt-lightning" style="color: #ffcc00;"></i> クイックサマリー</h3>
            <ul>
                <li><i class="fa-solid fa-circle-check"></i> <span><strong>主な役割:</strong> {{ item.title }}の核心的価値と業務範囲</span></li>
                <li><i class="fa-solid fa-circle-check"></i> <span><strong>必須スキル:</strong> 市場で最も求められる技術的専門性</span></li>
                <li><i class="fa-solid fa-circle-check"></i> <span><strong>将来性:</strong> キャリアの拡張性と今後の成長予測</span></li>
            </ul>
        </div>

        <!-- 자동 목차 -->
        <nav class="toc-container">
            <div class="toc-title">INDEX</div>
            <ul id="toc-list"></ul>
        </nav>

        <!-- 마크다운 본문 (JS가 표 스크롤 박스를 자동으로 생성함) -->
        <article id="content-main">
            {{ content | safe }}
        </article>

        <!-- 관련 직업 추천 -->
        <section style="margin-top: 100px;">
            <h3 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 40px; border-left: 6px solid var(--accent); padding-left: 20px;">関連性の高い職種</h3>
            <div class="main-grid">
                {% for job in related_jobs_data %}
                <a href="/career/{{ job.id }}" class="content-card" style="height: 240px;">
                    <div class="card-bg">
                        <img src="{{ job.thumbnail }}" onerror="this.src='https://images.unsplash.com/photo-1516321318423-f06f85e504b3?q=80&w=800&auto=format&fit=crop'">
                    </div>
                    <div class="card-overlay"></div>
                    <div class="card-body">
                        <h3 style="font-size: 1.25rem;">{{ job.title }}</h3>
                    </div>
                </a>
                {% endfor %}
            </div>
        </section>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const content = document.getElementById('content-main');
    
    // 1. 목차 생성 로직
    const tocList = document.getElementById('toc-list');
    const headings = content.querySelectorAll('h2, h3');
    if (headings.length === 0) {
        document.querySelector('.toc-container').style.display = 'none';
    } else {
        headings.forEach((heading, index) => {
            const id = 'anchor-' + index;
            heading.setAttribute('id', id);
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.setAttribute('href', '#' + id);
            a.textContent = heading.textContent;
            if (heading.tagName === 'H3') a.classList.add('toc-h3');
            li.appendChild(a);
            tocList.appendChild(li);
        });
    }

    // 2. 마크다운 표(table) 자동 래핑 (짤림 방지)
    const tables = content.querySelectorAll('table');
    tables.forEach(table => {
        const wrapper = document.createElement('div');
        wrapper.className = 'table-wrapper';
        table.parentNode.insertBefore(wrapper, table);
        wrapper.appendChild(table);
    });

    // 3. Adsense 'availableWidth=0' 해결을 위한 안전 호출 스크립트
    function initAdsOnReady() {
        const ads = document.querySelectorAll('.adsbygoogle:not([data-adsbygoogle-status="done"])');
        ads.forEach(ad => {
            // 부모의 너비가 확보될 때까지 기다렸다가 호출
            let checkWidth = setInterval(function() {
                if (ad.offsetWidth > 0) {
                    try {
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    } catch (e) { console.error("AdSense error:", e); }
                    clearInterval(checkWidth);
                }
            }, 100);
            // 3초 후 시도 중단
            setTimeout(() => clearInterval(checkWidth), 3000);
        });
    }

    // 페이지 로드 및 0.5초 지연 후 호출 (레이아웃 안정화 대기)
    initAdsOnReady();
    window.addEventListener('load', () => setTimeout(initAdsOnReady, 500));
});
</script>
{% endblock %}